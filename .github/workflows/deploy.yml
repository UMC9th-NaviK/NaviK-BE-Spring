name: EC2 deploy

on:
  push:
    branches:
      - "main"
      - "refactor/#52/ci-cd-ssm-https-jdk21"

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}
  ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: GitHub ì €ìž¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Gradle ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        run: chmod +x gradlew

      - name: JDK 21 ì„¤ì¹˜
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Spring Boot JAR ë¹Œë“œ (í…ŒìŠ¤íŠ¸ ì œì™¸)
        run: ./gradlew clean bootJar -x test

      - name: AWS ìžê²© ì¦ëª… ì„¤ì •
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ secrets.AWS_REGION }}
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: ECR ë¦¬í¬ì§€í† ë¦¬ ì¡´ìž¬ ì—¬ë¶€ í™•ì¸ ë° ìƒì„±
        run: |
          aws ecr describe-repositories --repository-names "$ECR_REPOSITORY" --region "$AWS_REGION" >/dev/null 2>&1 \
          || aws ecr create-repository --repository-name "$ECR_REPOSITORY" --region "$AWS_REGION"

      - name: Amazon ECR ë¡œê·¸ì¸
        uses: aws-actions/amazon-ecr-login@v2

      - name: ðŸ· Docker ì´ë¯¸ì§€ íƒœê·¸ ìƒì„±
        id: meta
        run: echo "tag=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° íƒœê¹…
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:${{ steps.meta.outputs.tag }} .
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:${{ steps.meta.outputs.tag }} $ECR_REGISTRY/$ECR_REPOSITORY:latest

      - name: Docker ì´ë¯¸ì§€ ECRì— í‘¸ì‹œ
        run: |
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:${{ steps.meta.outputs.tag }}
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

      - name: SSMìœ¼ë¡œ EC2ì— ë°°í¬
        id: ssm
        run: |
          set -euo pipefail

          REGION="${{ secrets.AWS_REGION }}"
          INSTANCE_ID="${{ secrets.EC2_INSTANCE_ID }}"
          TAG="${{ steps.meta.outputs.tag }}"
          ECR_IMAGE="${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY }}"

          COMMAND_ID=$(aws ssm send-command \
            --region "$REGION" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy via GitHub Actions (docker compose)" \
            --targets "Key=instanceids,Values=$INSTANCE_ID" \
            --parameters commands="[
              \"set -e\",
              \"export ECR_IMAGE=$ECR_IMAGE\",
              \"export IMAGE_TAG=$TAG\",
              \"/home/ubuntu/app/deploy.sh\"
            ]" \
            --query "Command.CommandId" \
            --output text)

          echo "command_id=$COMMAND_ID" >> $GITHUB_OUTPUT
          echo "SSM CommandId: $COMMAND_ID"

      - name: SSM ì‹¤í–‰ ê²°ê³¼ ëŒ€ê¸°
        run: |
          set -euo pipefail
          aws ssm wait command-executed \
            --region "${{ secrets.AWS_REGION }}" \
            --command-id "${{ steps.ssm.outputs.command_id }}" \
            --instance-id "${{ secrets.EC2_INSTANCE_ID }}"

      - name: SSM ë¡œê·¸ ì¶œë ¥ + ì‹¤íŒ¨ ì²˜ë¦¬
        run: |
          set -euo pipefail

          REGION="${{ secrets.AWS_REGION }}"
          CMD="${{ steps.ssm.outputs.command_id }}"
          INSTANCE="${{ secrets.EC2_INSTANCE_ID }}"

          STATUS=$(aws ssm get-command-invocation \
            --region "$REGION" \
            --command-id "$CMD" \
            --instance-id "$INSTANCE" \
            --query "Status" \
            --output text)

          echo "SSM Status: $STATUS"
          echo "---- STDOUT ----"
          aws ssm get-command-invocation \
            --region "$REGION" \
            --command-id "$CMD" \
            --instance-id "$INSTANCE" \
            --query "StandardOutputContent" \
            --output text || true
          echo "---- STDERR ----"
          aws ssm get-command-invocation \
            --region "$REGION" \
            --command-id "$CMD" \
            --instance-id "$INSTANCE" \
            --query "StandardErrorContent" \
            --output text || true

          if [ "$STATUS" != "Success" ]; then
            echo "SSM command failed."
            exit 1
          fi
