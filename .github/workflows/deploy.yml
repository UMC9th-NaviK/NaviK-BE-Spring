name: EC2 deploy

on:
  push:
    branches:
      - "main"
      - "feat/**"

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}
  ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: GitHub Ï†ÄÏû•ÏÜå Ï≤¥ÌÅ¨ÏïÑÏõÉ
        uses: actions/checkout@v4

      - name: Gradle Ïã§Ìñâ Í∂åÌïú Î∂ÄÏó¨
        run: chmod +x gradlew

      - name: JDK 21 ÏÑ§Ïπò
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Spring Boot JAR ÎπåÎìú (ÌÖåÏä§Ìä∏ Ï†úÏô∏)
        run: ./gradlew clean bootJar -x test

      - name: AWS ÏûêÍ≤© Ï¶ùÎ™Ö ÏÑ§Ï†ï
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ secrets.AWS_REGION }}
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: ECR Î¶¨Ìè¨ÏßÄÌÜ†Î¶¨ Ï°¥Ïû¨ Ïó¨Î∂Ä ÌôïÏù∏ Î∞è ÏÉùÏÑ±
        run: |
          aws ecr describe-repositories --repository-names "$ECR_REPOSITORY" --region "$AWS_REGION" >/dev/null 2>&1 \
          || aws ecr create-repository --repository-name "$ECR_REPOSITORY" --region "$AWS_REGION"

      - name: Amazon ECR Î°úÍ∑∏Ïù∏
        uses: aws-actions/amazon-ecr-login@v2

      - name: Docker Ïù¥ÎØ∏ÏßÄ ÌÉúÍ∑∏ ÏÉùÏÑ±
        id: meta
        run: echo "tag=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

      - name: Docker Ïù¥ÎØ∏ÏßÄ ÎπåÎìú Î∞è ÌÉúÍπÖ
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:${{ steps.meta.outputs.tag }} .
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:${{ steps.meta.outputs.tag }} $ECR_REGISTRY/$ECR_REPOSITORY:latest

      - name: Docker Ïù¥ÎØ∏ÏßÄ ECRÏóê Ìë∏Ïãú
        run: |
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:${{ steps.meta.outputs.tag }}
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

      - name: SSMÏúºÎ°ú EC2Ïóê Î∞∞Ìè¨
        id: ssm
        run: |
          set -euo pipefail

          REGION="${{ secrets.AWS_REGION }}"
          INSTANCE_ID="${{ secrets.EC2_INSTANCE_ID }}"
          TAG="${{ steps.meta.outputs.tag }}"
          ECR_IMAGE="${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY }}"

          COMMAND_ID=$(aws ssm send-command \
            --region "$REGION" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy via GitHub Actions (docker compose)" \
            --targets "Key=instanceids,Values=$INSTANCE_ID" \
            --parameters commands="[
              \"set -e\",
              \"export AWS_REGION=$REGION\",
              \"export ECR_IMAGE=$ECR_IMAGE\",
              \"export IMAGE_TAG=$TAG\",
              \"/home/ubuntu/app/deploy.sh\"
            ]" \
            --query "Command.CommandId" \
            --output text)

          echo "command_id=$COMMAND_ID" >> $GITHUB_OUTPUT
          echo "SSM CommandId: $COMMAND_ID"

      - name: SSM Ïã§Ìñâ Í≤∞Í≥º ÎåÄÍ∏∞
        continue-on-error: true
        run: |
          set -euo pipefail
          aws ssm wait command-executed \
            --region "${{ secrets.AWS_REGION }}" \
            --command-id "${{ steps.ssm.outputs.command_id }}" \
            --instance-id "${{ secrets.EC2_INSTANCE_ID }}"

      - name: SSM Î°úÍ∑∏ Ï∂úÎ†• + Ïã§Ìå® Ï≤òÎ¶¨
        run: |
          set -euo pipefail

          REGION="${{ secrets.AWS_REGION }}"
          CMD="${{ steps.ssm.outputs.command_id }}"
          INSTANCE="${{ secrets.EC2_INSTANCE_ID }}"

          STATUS=$(aws ssm get-command-invocation \
            --region "$REGION" \
            --command-id "$CMD" \
            --instance-id "$INSTANCE" \
            --query "Status" \
            --output text)

          echo "SSM Status: $STATUS"
          echo "---- STDOUT ----"
          aws ssm get-command-invocation \
            --region "$REGION" \
            --command-id "$CMD" \
            --instance-id "$INSTANCE" \
            --query "StandardOutputContent" \
            --output text || true
          echo "---- STDERR ----"
          aws ssm get-command-invocation \
            --region "$REGION" \
            --command-id "$CMD" \
            --instance-id "$INSTANCE" \
            --query "StandardErrorContent" \
            --output text || true

          if [ "$STATUS" != "Success" ]; then
            echo "SSM command failed."
            exit 1
          fi

      - name: Discord ÏïåÎ¶º
        if: always()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_DEPLOY_WEBHOOK_URL }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          INSTANCE_ID: ${{ secrets.EC2_INSTANCE_ID }}
        run: |
          set -euo pipefail

          SHA="${GITHUB_SHA::7}"
          BRANCH="${GITHUB_REF_NAME}"
          TAG="${GITHUB_SHA::7}"
          RUN_URL="https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          COMMIT_URL="https://github.com/${GITHUB_REPOSITORY}/commit/${GITHUB_SHA}"

          TITLE="üöÄ Î∞∞Ìè¨ ÏÑ±Í≥µ"
          COLOR=5763719
          EXTRA_FIELD=""

          if [ "${{ job.status }}" != "success" ]; then
            TITLE="‚ùå Î∞∞Ìè¨ Ïã§Ìå®"
            COLOR=15548997

            CMD="${{ steps.ssm.outputs.command_id }}"
            STDERR=$(aws ssm get-command-invocation \
              --region "$AWS_REGION" \
              --command-id "$CMD" \
              --instance-id "$INSTANCE_ID" \
              --query "StandardErrorContent" \
              --output text 2>/dev/null \
              | tail -n 10 \
              | sed 's/\\/\\\\/g; s/\"/\\\"/g; s/\r//g' \
              | cut -c 1-900 || true)     
          
            [ -z "$STDERR" ] && STDERR="(stderr ÏóÜÏùå)"
            EXTRA_FIELD=", {\"name\":\"SSM STDERR (last 10 lines)\",\"value\":\"\`\`\`$STDERR\`\`\`\"}"
          fi

          curl -sS -H "Content-Type: application/json" -X POST \
            -d "{
              \"embeds\": [{
                \"title\": \"$TITLE\",
                \"color\": $COLOR,
                \"fields\": [
                  {\"name\": \"Repository\", \"value\": \"${GITHUB_REPOSITORY}\", \"inline\": false},
                  {\"name\": \"Branch\", \"value\": \"${BRANCH}\", \"inline\": false},
                  {\"name\": \"Container Version\", \"value\": \"${TAG}\", \"inline\": false},
                  {\"name\": \"Actor\", \"value\": \"${GITHUB_ACTOR}\", \"inline\": false},
                  {\"name\": \"Commit\", \"value\": \"${COMMIT_URL}\", \"inline\": false},
                  {\"name\": \"Actions Run\", \"value\": \"${RUN_URL}\", \"inline\": false}
                  $EXTRA_FIELD
                ]
              }]
            }" \
            "$DISCORD_WEBHOOK_URL" || true


